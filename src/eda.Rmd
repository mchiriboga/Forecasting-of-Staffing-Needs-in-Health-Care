---
title: "EDA - Exploratory Data Analisys"
author: "Marcelle Chiriboga"
date: '2019-05-01'
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(forecast))
suppressPackageStartupMessages(library(reshape2))
```

## Load the Data

Our data is composed of two tables:

- **Exception Hours** (`exception_hours.csv`): contains the data related to exceptions occurred (or scheduled) between 2012 and 2019.

`train.csv` is the training set and it contains the data related to exceptions logged until 2017. It was created from `exception_hours.csv` by running it through the `src/split_train.R` script.

```{r load training data, include = FALSE}
# Load the exception hours data
exception_hours <- read_csv("../data/train.csv")
```

- **Productive Hours** (`productive_hours.csv`): contains the data related to hours worked from 2010 to present day.

```{r load productive_hours data, include = FALSE}
# Load productive_hours data
prod_hours <- read_csv("../data/productive_hours.csv")
```

In order to be able to analyze both tables together to compare expections with productive hours, we join both tables to bring the `WORKED_HRS` column into the `exception_hours` table.

```{r join tables}
# Aggregate the exceptions by PROGRAM, COST_CENTRE, JOB_FAMILY_DESCRIPTION, SHIFT_DATE, JOB_STATUS
exception_hours_agg <- exception_hours %>% 
  group_by(PROGRAM, COST_CENTRE, JOB_FAMILY_DESCRIPTION, SHIFT_DATE, JOB_STATUS) %>% 
  summarise(total_exception_hours = sum(EXCEPTION_HOURS), number_of_exceptions = n())

# Join tables
exception_and_productive_hours <- prod_hours %>% 
  left_join(exception_hours_agg, by = c("PROGRAM", "COST_CENTRE", "JOB_FAMILY_DESCRIPTION", "SHIFT_DATE", "FULL_PART_TIME" = "JOB_STATUS")) %>% 
  # remove data from 2012, since we don't have exception info for this period
  filter(year(SHIFT_DATE) > 2012)

# Replace NA values with 0
exception_and_productive_hours[c("total_exception_hours", "number_of_exceptions")][is.na(exception_and_productive_hours[c("total_exception_hours", "number_of_exceptions")])] <- 0
```

## Exploratory Data Analisys (EDA)

Let's first explore the data considering Providence Health Care as a whole, not making any distinction among facilities, program, and job families, for example.

#### Exception vs. Productive Hours

Analyze the exceptions occurred from 2013 to 2017, contrasting them with the productive hours in order to see if there is a correlation between them.

- **Monthly Analysis**

```{r data set - monthly basis}
# Create a data set considering a monthly basis
excep_prod_hours_monthly <- exception_and_productive_hours %>%
  # Consider the same window of the training set - data from 2013 to 2017
  filter(year(SHIFT_DATE) < 2018) %>% 
  # extract year and month
  mutate(year = year(SHIFT_DATE),
         month = month(SHIFT_DATE)) %>% 
  group_by(year, month) %>% 
  summarise(prod_hours = sum(WORKED_HRS), excep_hours = sum(total_exception_hours),total_exceptions = sum(number_of_exceptions))
```

```{r monthly time series}
# Create monthly time series
ts_prod_hours_monthly <- ts(excep_prod_hours_monthly$prod_hours, frequency = 12)
ts_excep_hours_monthly <- ts(excep_prod_hours_monthly$excep_hours, frequency = 12)
ts_excep_number_monthly <- ts(excep_prod_hours_monthly$total_exceptions, frequency = 12)
```

```{r time series visualization}
# Plot the time series
ts.plot(ts_prod_hours_monthly, ts_excep_hours_monthly, main = "Productive vs. Exceptions Hours (monthly)", xlab = "Year", ylab = "Hours")
plot(ts_prod_hours_monthly, main = "Productive Hours (monthly)", xlab = "Year", ylab = "Hours")
plot(ts_excep_hours_monthly, main = "Exceptions Hours (monthly)", xlab = "Year", ylab = "Hours")
plot(ts_excep_number_monthly, main = "Number of Exceptions (monthly)", xlab = "Year", ylab = "Number of Exceptions")
```

```{r plot the monthly decompositions}
# Plot the decompositions
# Productive hours
dec_ts_prod_hours_monthly <- decompose(ts_prod_hours_monthly)
plot(dec_ts_prod_hours_monthly)

# Exception hours
dec_ts_excep_hours_monthly <- decompose(ts_excep_hours_monthly)
plot(dec_ts_excep_hours_monthly)

# Total number of exceptions
dec_ts_excep_number_monthly <- decompose(ts_excep_number_monthly)
plot(dec_ts_excep_number_monthly)
```

- **Weekly Analysis**

```{r data set - weekly basis}
# Create a data set considering a weekly basis
excep_prod_hours_weekly <- exception_and_productive_hours %>%
  # Consider the same window of the training set - data from 2013 to 2017
  filter(year(SHIFT_DATE) < 2018) %>% 
  # extract year and week
  mutate(year = year(SHIFT_DATE),
         week = week(SHIFT_DATE)) %>% 
  group_by(year, week) %>% 
  summarise(prod_hours = sum(WORKED_HRS),excep_hours = sum(total_exception_hours),total_exceptions = sum(number_of_exceptions)) %>% 
  # remove the last week of each year (week 53), since they consider few days
  filter(week != 53)
```

```{r weekly time series}
# Create weekly time series
ts_prod_hours_weekly <- ts(excep_prod_hours_weekly$prod_hours, start = c(2013, 1), frequency = 52)
ts_excep_hours_weekly <- ts(excep_prod_hours_weekly$excep_hours, start = c(2013, 1), frequency = 52)
ts_excep_number_weekly <- ts(excep_prod_hours_weekly$total_exceptions, start = c(2013, 1), frequency = 52)

# Plot the time series
ts.plot(ts_prod_hours_weekly, ts_excep_hours_weekly, main = "Productive Hours vs. Number of Exceptions - weekly")
plot(ts_prod_hours_weekly, main = "Productive Hours (weekly)", xlab = "Year", ylab = "Hours")
plot(ts_excep_hours_weekly, main = "Exceptions Hours (weekly)", xlab = "Year", ylab = "Hours")
plot(ts_excep_number_weekly, main = "Number of Exceptions (weekly)", xlab = "Year", ylab = "Number of Exceptions")
```

```{r plot the weekly decompositions}
# Plot the decompositions
# Productive hours
dec_ts_prod_hours_weekly <- decompose(ts_prod_hours_weekly)
plot(dec_ts_prod_hours_weekly)

# Exception hours
dec_ts_excep_hours_weekly <- decompose(ts_excep_hours_weekly)
plot(dec_ts_excep_hours_weekly)

# Total number of exceptions
dec_ts_excep_number_weekly <- decompose(ts_excep_number_weekly)
plot(dec_ts_excep_number_weekly)
```


**Observations:**

- All analyses (monthly and weekly for productive hours, exception hours and number of exceptions) indicate an increasing trend over the years.
- The weekly analyses show that the seasonal component has a trough every year during week 52, i.e. much lower numbers for productive hours, exception hours and number of exceptions in comparison to other surrounding weeks.

```{r }
excep_prod_hours_weekly %>% 
  filter(week %in% c(50, 51, 52, 1, 2), !(week %in% c(1, 2) & year == 2013))
```

- At a glance, the expectation would be for weeks with lower productive hours to have higher exceptions (number and/or hours). However, this doesn't seem to be true for week 52, as all values are lower than other weeks.
  - *Do holidays play a part in this? That is, do weeks that have holidays have lower productive hours, but also lower exceptions? Are holidays not taken into account in exceptions?*

### Exploring the 'exception_hours' data set

Now focusing only on the `exception_hours.csv`, let's explore how exceptions are distributed accross some of the variables.

#### `SITE`

```{r}
# Check the total number of exceptions by facilities
(facilities <- exception_hours %>% 
  group_by(SITE) %>% 
  filter(SITE %in% c("Billable", "Brock Fahrni", "Holy Family", "Mt St Joseph", "PHC Corporate", "St John Hospice", "St Paul's Hospital", "SVH Honoria Conway", "SVH Langara", "Youville Residence")) %>%
  summarise(count = n()) %>% 
  arrange(desc(count))
 )
```

**Observation:**

- Considering the total number of exceptions from 2013 to 2017, `St Paul's Hospital`, `Mt St Joseph`, `Holy Family` are the top facilities, where `St Paul's Hospital` has ~5x more exceptions than the second facility, `Mt St Joseph`.

#### `LABOR_AGREEMENT`

```{r number of exceptions by labor agreement}
# Rank the total number of exceptions by labor agreement
(labor_agreement <- exception_hours %>% 
  group_by(LABOR_AGREEMENT) %>%
  filter(!(LABOR_AGREEMENT %in% c('NULL', '0'))) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))
)

# Visualize the total number of exceptions by labor agreement facetting by site
exception_hours %>%
  filter(!(LABOR_AGREEMENT %in% c('NULL', '0')), SITE %in% c("Billable", "Brock Fahrni", "Holy Family", "Mt St Joseph", "PHC Corporate", "St John Hospice", "St Paul's Hospital", "SVH Honoria Conway", "SVH Langara", "Youville Residence")) %>%
  ggplot(aes(x = LABOR_AGREEMENT)) +
  geom_bar(stat = "count") +
  facet_wrap(~SITE) +
  theme_bw() +
    ggtitle("Number of Exceptions by Labor Agreement per Site (2013 - 2017)") +
    theme(plot.title = element_text(hjust = 0.5))
```

**Observations:**

- Considering the total number of exceptions from 2013 to 2017, `FAC`, `NURS` and `PARMED` are the top 3 `LABOR_AGREEMENT`.
- Most of the exceptions are from `St. Paul's Hospital`, where the majority are related to `NURS`. 

#### `JOB_FAMILY_DESCRIPTION`

Exploring the `JOB_FAMILY_DESCRIPTION` of the main `LABOR_AGREEMENT`:

```{r Expand FAC LABOR_AGREEMENT}
# FAC job families
fac_job_family <- exception_hours %>% 
   filter(LABOR_AGREEMENT == "FAC") %>%
   group_by(JOB_FAMILY_DESCRIPTION) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))

# Print the top 10 FAC job families
head(fac_job_family, 10)
```

```{r Expand NURS LABOR_AGREEMENT}
# NURS job families
nurs_job_family <- exception_hours %>% 
   filter(LABOR_AGREEMENT == "NURS") %>%
   group_by(JOB_FAMILY_DESCRIPTION) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))

# Print the top 10 NURS job families
head(nurs_job_family, 10)
```

```{r Expand PARMED LABOR_AGREEMENT}
# PARMED job families
parmed_job_family <- exception_hours %>% 
   filter(LABOR_AGREEMENT == "PARMED") %>%
   group_by(JOB_FAMILY_DESCRIPTION) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))

# Print the top 10 PARMED job families
head(parmed_job_family, 10)
```

#### `EXCEPTION_GROUP`

- Considering all sites

```{r exception groups}
# Check the total number of exceptions by each exception group
(exception_groups <- exception_hours %>% 
  group_by(EXCEPTION_GROUP) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))
 )
```

Most exceptions fall under`Other`. Let's look at those to see what are some of the exception reasons associated under this group.

```{r Other exception reason}
# Check the total number of `Other` exceptions by each exception reason
other_exception_reason <- exception_hours %>% 
  filter(EXCEPTION_GROUP == "Other") %>% 
  group_by(EXCEPTION_REASON) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))

head(other_exception_reason, 10)

# Check the total number of other exceptions
sum(other_exception_reason$count) == exception_groups$count[exception_groups$EXCEPTION_GROUP == 'Other']
```

- Focusing on `St Paul's Hospital` `EXCEPTION_GROUP` to check if the main groups are the same as the ones considering PHC as a whole. 

```{r St Pauls Hospital exception groups}
# Check the St Pauls Hospital total number of exceptions by each exception group
(exception_groups_st_paul <- exception_hours %>% 
  filter(SITE == "St Paul's Hospital") %>% 
  group_by(EXCEPTION_GROUP) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))
)
```

```{r St Pauls Hospital other exception reason}
# Check the St Paul's Hospital total number of `Other` exceptions by each exception reason
other_exception_reason_st_paul <- exception_hours %>% 
  filter(SITE == "St Paul's Hospital" & EXCEPTION_GROUP == "Other") %>% 
  group_by(EXCEPTION_REASON) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count))

head(other_exception_reason_st_paul, 10)

# Check the total number of other exceptions
sum(other_exception_reason_st_paul$count) == exception_groups_st_paul$count[exception_groups$EXCEPTION_GROUP == 'Other']
```

**Observations:**

1. Main `EXCEPTION_GROUP`:
- PHC as a whole: `Other` > `Vacation` > `Paid Sick` > `Swap`
- `St. Paul’s Hospital`:  `Other` > `Vacation` > `Swap` > `Workload`

2. Main `EXCEPTION_REASON` related to `Other` `EXCEPTION_GROUP`
- PHC as a whole: `REG- Regular Hrs - MV- Move`, `PVC- Vacation Regular - MV- Move`, `REG- Regular Hrs`, `FTE- Flex Time Earned NC`
- `St. Paul’s Hospital`: `FTE- Flex Time Earned NC`, `REG- Regular Hrs - MV- Move`, `PVC- Vacation Regular - MV- Move`, `REG- Regular Hrs`


