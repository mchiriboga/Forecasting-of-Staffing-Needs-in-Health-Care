---
title: "Time Series Draft"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# packages
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(forecast))
```

## Readme

This is a draft by Iris, exploring time series of the data. Includes unfinished pieces of work, just for reference.

**PLEASE DO NOT KNIT THE WHOLE FILE.**

## Load Data

`train.csv` is the training set, including data till end of 2017.

Generated by `split_by_year.R`.

```{r load data, include=FALSE}
df <- read_csv("../data/train.csv")
#df18 <- read_csv("data/raw_2018.csv")
```

## Daily Analysis (TBC)

- Data in 2012 has only the day `2012-12-31`.
- Remove the leap year `2016-02-29` to use `frequency = 365`.
- Total number of rows after grouping: (365*5)+1=1826.

```{r daily: data wrangling}
# daily number of exceptions from 2012-12-31 to 2017-12-31
daily <- df %>%
  # remove extra day in leap year 2016
  filter(SHIFT_DATE != as.Date("2016-02-29")) %>% 
  # summarise the number of exceptions in a day
  group_by(SHIFT_DATE) %>% 
  summarise(count = n()) %>% 
  ungroup()

# check number of entries
nrow(daily)
```

```{r daily: time series}
# create time series for daily data
ts_day <- ts(daily$count, frequency = 365)
# decompose
dec_day <- decompose(ts_day)
# visualize
plot(dec_day)
# plot acf
acf(ts_day)
```

## Weekly Analysis

- Aggregate weekly data throughout the year.
- Note: lubridate `week()` does not gives correct week; just every 7 days each year.

```{r weekly: data wrangling}
weekly <- df %>% 
  # exclude data for 2012-12-31 for now
  filter(year(SHIFT_DATE) > 2012) %>% 
  # extract year and week
  mutate(year = year(SHIFT_DATE),
         week = week(SHIFT_DATE)) %>% 
  # get number of weekly exceptions
  group_by(year, week) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  # index column for plotting
  mutate(id = seq.int(265))

head(weekly)
```

```{r weekly: test cell, eval = FALSE}
# explore the week pattern
# do not render now

temp <- df %>% 
  filter(year(SHIFT_DATE) > 2012) %>% 
  mutate(year = year(SHIFT_DATE),
         week = week(SHIFT_DATE)) %>% 
  filter(week == 53 | week == 1) %>% 
  group_by(SHIFT_DATE, week) %>% 
  summarise(count = n())

week(as.Date("2013-01-08"))
```


```{r weekly: time series}
# create time series
ts_week <- ts(weekly$count, frequency = 53)

# decomposition
dec_week <- decompose(ts_week)
#plot(dec_week)
#plot(dec_week$seasonal)
#dec_week$trend

# loess method
stl_week <- stl(ts_week, s.window = "periodic")
#plot(stl_week)

# fields of loess
stl_week$time.series[,'seasonal']  # seasonality
stl_week$time.series[,2]  # trend

week_test <- weekly %>% 
  # holt-winter
  #mutate(hw_pred = tbats(ts_week)$fitted) %>% 
  # decompose
  #mutate(seasonal = dec_week$seasonal) %>% 
  #mutate(seasonal = seasonal + dec_week$trend) %>% 
  # loess method
  mutate(loess = stl_week$time.series[,'seasonal']) %>% 
  mutate(loess = loess + stl_week$time.series[,2])

ggplot(week_test) +
  geom_line(aes(x = id, y = count)) +
  geom_line(aes(x = id, y = loess), color = 'red')
```

--------

**Unfinished Analysis Below**

--------

## All Years, number of exceptions

- Group by day
- Use data 2012 to 2017

```{r number of exceptions by day}
all_num_day <- df %>% 
  filter(SHIFT_DATE < as.Date("2018-01-01")) %>% 
  group_by(SHIFT_DATE) %>% 
  summarise(count = n()) %>% 
  ungroup()
```

```{r}
tsr <- ts(all_num_day$count, frequency = 7)
plot(tsr)
```

## Week/Day analysis

```{r}
df18 %>% 
  mutate(week = week(SHIFT_DATE), weekday = wday(SHIFT_DATE)) %>% 
  group_by(SHIFT_DATE, week, weekday) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  ggplot(aes(x = weekday, y = count, color = as.factor(week))) +
  geom_line()
```

```{r}
test <- df18 %>% 
  group_by(SHIFT_DATE) %>% 
  summarise(count = n())

tsrr <- ts(test$count, frequency = 7)
plot(tsrr)
dec <- decompose(tsrr)

dec$seasonal
```

## Hours of exceptions

```{r}
df_hours <- df %>% 
  # generate shift time to hours
  mutate(hours = as.numeric((END_TIME - START_TIME)/3600)) %>% 
  # for the shift time across midnight
  # adjust the negative result to actual hours 
  mutate(hours = ifelse(hours > 0, hours, 24 + hours))
```