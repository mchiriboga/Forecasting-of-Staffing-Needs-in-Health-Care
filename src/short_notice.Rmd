---
title: "Short Notice Pattern"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# packages
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(prophet))
suppressPackageStartupMessages(library(MLmetrics))
```

## Introduction

In this draft we explore the short notice pattern for the nurses. There are two kind of short notice:

- Less than one week, and
- Less than 48 hours.

We will explore the percentage/amount of the short notice exceptions by week.

## Load Data

For tuning the model, we use the training data, including the exceptions from end of 2012 to end of 2017.

```{r Load data}
df <- read_csv("../data/train.csv")
```

```{r Prepare Data}
short_notice <- df %>% 
  filter(SHIFT_DATE < as.Date("2017-12-31")) %>% 
  mutate(notice = seconds_to_period(SHIFT_START_DATE_TIME - EXCEPTION_CREATION_DATE)) %>% 
  mutate(notice_week = notice < period(7, "days"),
         notice_48hr = notice < period(2, "days")) %>% 
  select(SHIFT_DATE, JOB_FAMILY, notice_week, notice_48hr)
```

```{r}
sum(short_notice$notice_week)/nrow(short_notice)
```

## Short Notice One Week Before: Overall Weekly Pattern

```{r Overall: Weekly Analysis}
# for each week, get the percentage of "Overtime" over all exceptions
# ds: first day of that week
short_notice %>% 
  mutate(ds = floor_date(SHIFT_DATE, unit = "week")) %>% 
  group_by(ds) %>% 
  summarise(y = sum(notice_week)/n()) %>% 
  ggplot() +
  geom_line(aes(x = ds, y = y, color = factor(year(ds))))
```

## Job Family: DC1000 (Registered Nurse-DC1)

First we prepare data for the group of DC1000, which is "Registered Nurse-DC1": 

```{r DC1: data}
dc1 <- short_notice %>% 
  filter(JOB_FAMILY == "DC1000")

# check the amount of data we have
nrow(dc1)
```

```{r DC1: EDA}
# get the percentage of "Overtime" over all exceptions
dc1_daily <- dc1 %>% 
  group_by(SHIFT_DATE) %>% 
  summarise(y = sum(notice_week)/n()) %>% 
  select(ds = SHIFT_DATE, y)

# get the average percentage of a week
# ds: first day of that week
dc1_weekly <- dc1_daily %>% 
  mutate(ds = floor_date(ds, unit = "week")) %>% 
  group_by(ds) %>% 
  summarise(y = mean(y))

## visualization
ggplot() +
  geom_line(data = dc1_weekly, aes(x = week(ds), y = y, color = factor(year(ds))))
```

```{r DC1: Predict by Prophet}
# split train and validate
train <- dc1_weekly %>% 
  filter(year(ds) %in% c(2013, 2014, 2015, 2016))

# get the end date of training set
end_date <- max(train$ds)

# generate model
m <- prophet(train, 
             yearly.seasonality = TRUE)
  
# predict
future <- make_future_dataframe(m, periods = 365)
prediction <- predict(m, future)
```

```{r DC1: Prediction All}
# aggregate the predicted result by week
pred_all <- prediction %>% 
  mutate(ds = floor_date(ds, unit = "week")) %>% 
  group_by(ds) %>% 
  summarise(yhat = mean(yhat))

# aggregate the validation data by week
val_all <- dc1_weekly %>% 
  filter(ds < as.Date("2017-12-31"))

# make a visualize of the predicted data we have
ggplot() +
  geom_line(data = val_all, aes(x = as.Date(ds), y = y, color = "Actual Data")) +
  geom_line(data = pred_all, aes(x = as.Date(ds), y = yhat, color = "Prediction"))
```

```{r DC: Prediction 2017}
# make a visualization for the prediction period: 2017
pred_17 <- pred_all %>% 
  filter(year(ds) > 2016)

val_17 <- val_all %>% 
  filter(year(ds) > 2016) %>% 
  select(ds, y)

ggplot() +
  geom_line(data = val_17, aes(x = as.Date(ds), y = y, color = "Val")) +
  geom_line(data = pred_17, aes(x = as.Date(ds), y = yhat, color = "Pred"))
```

```{r DC1: Intervals}
# Idea: Use Loess to get a smoothed interval
pp <- pred_all %>% 
  mutate(id = week(ds))

ll <- loess(yhat ~ week(ds), data = pp, span = 0.2)
out <- predict(ll)

interval <- pred_all %>% 
  mutate(upper = out + 0.04,
         lower = out - 0.05)

# visualize the intervals
ggplot() +
  geom_line(data = val_all, aes(x = as.Date(ds), y = y, color = "Val")) +
  geom_line(data = interval, aes(x = as.Date(ds), y = yhat, color = "yhat")) +
  geom_line(data = interval, aes(x = as.Date(ds), y = upper, color = "loess")) +
  geom_line(data = interval, aes(x = as.Date(ds), y = lower, color = "loess"))
```

```{r DC1: Intervals 2017}
interval_17 <- interval %>%
  filter(year(ds) > 2016)

# visualize the intervals
ggplot() +
  geom_line(data = val_17, aes(x = as.Date(ds), y = y, color = "Val")) +
  geom_line(data = interval_17, aes(x = as.Date(ds), y = yhat, color = "yhat")) +
  geom_line(data = interval_17, aes(x = as.Date(ds), y = upper, color = "loess")) +
  geom_line(data = interval_17, aes(x = as.Date(ds), y = lower, color = "loess"))
```

```{r DC1: Accuracy}
result <- interval_17 %>% 
  mutate(y = val_17$y) %>% 
  filter(year(ds) > 2016) 

result %>% 
  mutate(test = y < upper & y > lower) %>% 
  group_by() %>% 
  summarise(sum = sum(test)) %>% 
  mutate(accuracy = sum/nrow(result))
```

```{r DC1: Sample Output}
result %>% 
  select(-y)
```

## Job Family: DC2A00 (Registered Nurse-DC2A)

First we prepare data for the group of DC2A00: 

```{r DC2A: data}
dc2a <- short_notice %>% 
  filter(JOB_FAMILY == "DC2A00")

# check the amount of data we have
nrow(dc2a)
```


```{r DC2A: EDA}
# get the percentage of "Overtime" over all exceptions
dc2a_daily <- dc2a %>% 
  group_by(SHIFT_DATE) %>% 
  summarise(y = sum(notice_week)/n()) %>% 
  select(ds = SHIFT_DATE, y)

# get the average percentage of a week
# ds: first day of that week
dc2a_weekly <- dc2a_daily %>% 
  mutate(ds = floor_date(ds, unit = "week")) %>% 
  group_by(ds) %>% 
  summarise(y = mean(y))

## visualization
ggplot() +
  geom_line(data = dc2a_weekly, aes(x = week(ds), y = y, color = factor(year(ds))))
```

- No Appearant Pattern, but small in some middle weeks.

```{r DC2A: EDA}
# get the percentage of "Overtime" over all exceptions
dc2a_daily <- dc2a %>% 
  filter(EARNING_CATEGORY == "Overtime") %>% 
  group_by(SHIFT_DATE) %>% 
  summarise(y = n()) %>% 
  select(ds = SHIFT_DATE, y)
  #mutate(overtime = EARNING_CATEGORY == "Overtime") %>% 
  #group_by(SHIFT_DATE) %>% 
  #summarise(over = sum(overtime), total = n()) %>% 
  #mutate(y = over/total) %>% 
  #select(ds = SHIFT_DATE, y)

# get the average percentage of a week
# ds: first day of that week
dc2a_weekly <- dc2a_daily %>% 
  mutate(ds = floor_date(ds, unit = "week")) %>% 
  group_by(ds) %>% 
  summarise(y = sum(y))

## visualization
ggplot() +
  geom_line(data = dc2a_weekly, aes(x = week(ds), y = y, color = factor(year(ds))))
```

```{r DC2A: Weekly Interval}
dc2a_weekly %>% 
  mutate(test = y < 56 & y > 24) %>% 
  group_by() %>% 
  summarise(sum = sum(test)) %>% 
  mutate(accuracy = sum/nrow(dc2a_weekly))
```

```{r DC2A: Daily Pattern}
# get the percentage of "Overtime" over all exceptions
dc2a_daily <- dc2a %>% 
  filter(EARNING_CATEGORY == "Overtime") %>% 
  group_by(SHIFT_DATE) %>% 
  summarise(y = n()) %>% 
  select(ds = SHIFT_DATE, y)

## visualization
ggplot() +
  geom_jitter(data = dc2a_daily, aes(x = wday(ds), y = y, color = factor(year(ds))))
```

```{r DC2A: Weekend Interval}
dc2a_daily %>% 
  filter(wday(ds) %in% c(0,7)) %>% 
  mutate(test = y < 6) %>% 
  group_by() %>% 
  summarise(sum = sum(test)) %>% 
  mutate(accuracy = sum/248)
```

```{r DC2A: Weekday Interval}

dc2a_daily %>% 
  filter(wday(ds) %in% c(1,2,3,4,5,6)) %>% 
  mutate(test = y < 12) %>% 
  group_by() %>% 
  summarise(sum = sum(test)) %>% 
  mutate(accuracy = sum/1549)
```

```{r DC2A: St Paul's Hospital}
dc2a_sph <- df %>% 
  filter(JOB_FAMILY == "DC2A00",
         SITE == "St Paul's Hospital")

# get the percentage of "Overtime" over all exceptions
dc2a_sph_daily <- dc2a_sph %>% 
  filter(EARNING_CATEGORY == "Overtime") %>% 
  group_by(SHIFT_DATE) %>% 
  summarise(y = n()) %>% 
  select(ds = SHIFT_DATE, y)


# get the average percentage of a week
# ds: first day of that week
dc2a_sph_weekly <- dc2a_sph_daily %>% 
  mutate(ds = floor_date(ds, unit = "week")) %>% 
  group_by(ds) %>% 
  summarise(y = sum(y))

## visualization
ggplot() +
  geom_jitter(data = dc2a_sph_weekly, aes(x = week(ds), y = y, color = factor(year(ds))))
```

```{r DC2A: Weekly Interval, SPH}
dc2a_sph_weekly %>% 
  mutate(test = y < 56 & y > 20) %>% 
  group_by() %>% 
  summarise(sum = sum(test)) %>% 
  mutate(accuracy = sum/nrow(dc2a_sph_weekly))
```

```{r DC2A: Mt St Joseph}
dc2a_msj <- df %>% 
  filter(JOB_FAMILY == "DC2A00",
         SITE == "Mt St Joseph")

# get the percentage of "Overtime" over all exceptions
dc2a_msj_daily <- dc2a_msj %>% 
  filter(EARNING_CATEGORY == "Overtime") %>% 
  group_by(SHIFT_DATE) %>% 
  summarise(y = n()) %>% 
  select(ds = SHIFT_DATE, y)


# get the average percentage of a week
# ds: first day of that week
dc2a_msj_weekly <- dc2a_msj_daily %>% 
  mutate(ds = floor_date(ds, unit = "week")) %>% 
  group_by(ds) %>% 
  summarise(y = sum(y))

## visualization
ggplot() +
  geom_jitter(data = dc2a_sph_weekly, aes(x = week(ds), y = y, color = factor(year(ds))))
```

```{r DC2A: Weekly Interval, MSJ}
dc2a_msj_weekly %>% 
  mutate(test = y < 11) %>% 
  group_by() %>% 
  summarise(sum = sum(test)) %>% 
  mutate(accuracy = sum/nrow(dc2a_sph_weekly))
```


```{r DC2A: Other}
dc2a_other <- df %>% 
  filter(JOB_FAMILY == "DC2A00",
         SITE != "St Paul's Hospital" & SITE != "Mt St Joseph")

# get the percentage of "Overtime" over all exceptions
dc2a_other_daily <- dc2a_other %>% 
  filter(EARNING_CATEGORY == "Overtime") %>% 
  group_by(SHIFT_DATE) %>% 
  summarise(y = n()) %>% 
  select(ds = SHIFT_DATE, y)


# get the average percentage of a week
# ds: first day of that week
dc2a_other_weekly <- dc2a_other_daily %>% 
  mutate(ds = floor_date(ds, unit = "week")) %>% 
  group_by(ds) %>% 
  summarise(y = sum(y))

## visualization
ggplot() +
  geom_jitter(data = dc2a_other_weekly, aes(x = week(ds), y = y, color = factor(year(ds))))
```

```{r DC2A: Weekly Interval, Other}
dc2a_other_weekly %>% 
  mutate(test = y < 5) %>% 
  group_by() %>% 
  summarise(sum = sum(test)) %>% 
  mutate(accuracy = sum/nrow(dc2a_other_weekly))
```


**Summary:**

It's hardly any pattern for the `DC2A000` group, and the number of overtime exceptions are not large. The majority comes from St Paul's Hospital, then Mt St Joseph, the others altogether have less than 5 exceptions each week with over 95% probability. 

We want to know if this data would be useful in the report.