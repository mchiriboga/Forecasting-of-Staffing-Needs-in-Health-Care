---
title: "Untitled"
author: "Weifeng Davy Guo"
date: '2019-05-08'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(forecast))
suppressPackageStartupMessages(library(datetime))
```

```{r}
data <- read_csv("exception_hours.csv")
```
```{r}
head(data)
```


```{r}
# generate historical records of nurse only for St Paul's Hospital, set the "week" as the first day of that week
(df <- data %>%
   filter(year(SHIFT_DATE) < 2019,LABOR_AGREEMENT == "NURS") %>%  
   filter(!grepl('Cancelled by Unit|Cancelled by Scheduler', EXCEPTION_REASON)) %>%
   filter(!grepl('Education|Swap', EXCEPTION_GROUP)) %>%
   filter(!grepl('Relief Not Needed', EARNING_CATEGORY)) %>%
   filter(SITE %in% c("Brock Fahrni", "Holy Family","Mt St Joseph",
                     "St Paul's Hospital", "SVH Langara","Youville Residence")) %>%
   mutate(NOTICE = ceiling(as.numeric(SHIFT_START_DATE_TIME - EXCEPTION_CREATION_DATE)),
          AWARE = ceiling(as.numeric(MIN_CALL_DATE_TIME - EXCEPTION_CREATION_DATE)),
          WEEKDAY = weekdays(SHIFT_DATE),
          MONTH = month(SHIFT_DATE)) %>%
   select("EXCEPTION_GROUP","WEEKDAY","SITE","MONTH","PROGRAM","SUB_PROGRAM","JOB_FAMILY",
          "EXCEPTION_HOURS","SHIFT_DATE",
          "NOTICE","AWARE","EARNING_CATEGORY") %>% 
   filter(NOTICE >0) %>% 
   mutate(WEEKDAY = as.numeric(as.character(fct_recode(WEEKDAY,
                            "1" = "Monday", 
                            "1" = "Tuesday", 
                            "1" = "Wednesday",
                            "1" = "Thursday", 
                            "1" = "Friday", 
                            "0" = "Saturday",
                            "0" = "Sunday")))) %>%
   mutate(SITE = as.numeric(factor(SITE))) %>%
   mutate(PROGRAM = as.numeric(factor(PROGRAM))) %>%
   mutate(SUB_PROGRAM = as.numeric(factor(SUB_PROGRAM))) %>%
   mutate(EXCEPTION_GROUP = as.numeric(factor(EXCEPTION_GROUP))) %>%
   mutate(JOB_FAMILY = as.numeric(factor(JOB_FAMILY))) 
 )
df[is.na(df)] <- 0
```
```{r}
df
```


```{r}
# generate dataframe with 4 labels
 (df1 <- df %>% 
    mutate(EARNING_CATEGORY = fct_recode(EARNING_CATEGORY,
                            "Straight Time" = "Regular Relief Utilized",
                            "Straight Time" = "Casual at Straight-Time", 
                            "Straight Time" = "PT Over FTE",
                            "Straight Time" = "Miscellaneous Straight-Time",
                            "Straight Time" = "PT Employee Moved - Straight-Time", 
                            "Straight Time" = "FT Employee Moved - Straight-Time",
                            "Others" = "Agency",
                            "Others" = "Insufficient Notice", 
                            "Others" = "On-Call"))
  )
# generate dataframe with 2 labels
 (df2 <- df %>% 
    mutate(EARNING_CATEGORY = fct_recode(EARNING_CATEGORY,
                            "Straight Time" = "Regular Relief Utilized",
                            "Straight Time" = "Casual at Straight-Time", 
                            "Straight Time" = "PT Over FTE",
                            "Straight Time" = "Miscellaneous Straight-Time",
                            "Straight Time" = "PT Employee Moved - Straight-Time", 
                            "Straight Time" = "FT Employee Moved - Straight-Time",
                            "Overtime and Beyond" = "Overtime", 
                            "Overtime and Beyond" = "Relief Not Found",
                            "Overtime and Beyond" = "Agency",
                            "Overtime and Beyond" = "Insufficient Notice", 
                            "Overtime and Beyond" = "On-Call"))
  )
```

```{r}
# generate dataframe with 3 labels
 # (df3 <- df %>% 
 #    mutate(EARNING_CATEGORY = fct_recode(EARNING_CATEGORY,
 #                            "Straight Time" = "Regular Relief Utilized",
 #                            "Straight Time" = "Casual at Straight-Time", 
 #                            "Straight Time" = "PT Over FTE",
 #                            "Straight Time" = "Miscellaneous Straight-Time",
 #                            "Straight Time" = "PT Employee Moved - Straight-Time", 
 #                            "Straight Time" = "FT Employee Moved - Straight-Time",
 #                            "Overtime and Agency" = "Overtime", 
 #                            "Overtime and Agency" = "Agency",
 #                            "Overtime and Agency" = "Insufficient Notice", 
 #                            "Overtime and Agency" = "On-Call"))
 #  )
```



```{r}
write.csv(df1, file = "classification1.csv")
write.csv(df2, file = "classification2.csv")
```












