---
title: "Untitled"
author: "Weifeng Davy Guo"
date: '2019-05-08'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(forecast))
suppressPackageStartupMessages(library(datetime))
```

```{r}
data <- read_csv("exception_hours.csv")
```
```{r}
head(data)
```


```{r}
# generate historical records of nurse only for St Paul's Hospital, set the "week" as the first day of that week
(df <- data %>%
   filter(year(SHIFT_DATE) < 2019,LABOR_AGREEMENT == "NURS") %>%  
   filter(!grepl('Cancelled by Unit|Cancelled by Scheduler', EXCEPTION_REASON)) %>%
   filter(!grepl('Education|Swap', EXCEPTION_GROUP)) %>%
   filter(!grepl('Relief Not Needed', EARNING_CATEGORY)) %>%
   filter(SITE %in% c("Brock Fahrni", "Holy Family","Mt St Joseph",
                     "St Paul's Hospital", "SVH Langara","Youville Residence")) %>%
   filter(JOB_FAMILY %in% c("DC1000", "DC2B00","DC2A00")) %>% 
   mutate(NOTICE = ceiling(as.numeric(SHIFT_START_DATE_TIME - EXCEPTION_CREATION_DATE)/3600),
          WEEKDAY = weekdays(SHIFT_DATE),
          MONTH = month(SHIFT_DATE),
          WEEK = cut(as.Date(SHIFT_DATE), "week")) %>%
   arrange(WEEK) %>% 
   select("EXCEPTION_HOURS","SHIFT_DATE","WEEKDAY","NOTICE","EARNING_CATEGORY",
          "JOB_FAMILY","SITE","MONTH","WEEK") %>% 
   filter(NOTICE >0) %>% 
   mutate(WEEKDAY = as.numeric(as.character(fct_recode(WEEKDAY,
                            "1" = "Monday", 
                            "1" = "Tuesday", 
                            "1" = "Wednesday",
                            "1" = "Thursday", 
                            "1" = "Friday", 
                            "0" = "Saturday",
                            "0" = "Sunday")))) %>% 
   mutate(SITE = as.numeric(as.character(fct_recode(SITE,
                            "1" = "St Paul's Hospital", 
                            "2" = "Mt St Joseph", 
                            "3" = "Holy Family",
                            "4" = "SVH Langara", 
                            "5" = "Brock Fahrni", 
                            "6" = "Youville Residence")))) %>% 
   mutate(JOB_FAMILY = as.numeric(as.character(fct_recode(JOB_FAMILY,
                            "1" = "DC1000",
                            "2" = "DC2B00", 
                            "3" = "DC2A00")))) %>% 
   mutate(EARNING_CATEGORY = fct_recode(EARNING_CATEGORY,
                            "Straight Time" = "Regular Relief Utilized",
                            "Straight Time" = "Casual at Straight-Time", 
                            "Straight Time" = "PT Over FTE",
                            "Straight Time" = "Miscellaneous Straight-Time",
                            "Straight Time" = "PT Employee Moved - Straight-Time", 
                            "Straight Time" = "FT Employee Moved - Straight-Time",
                            "Others" = "Agency",
                            "Others" = "Insufficient Notice", 
                            "Others" = "On-Call"))
 )
```
		
	
```{r}
 (df1 <- df %>% 
    group_by(EARNING_CATEGORY) %>% 
    summarise(TOTAL =n())%>%
    arrange(TOTAL))
```
```{r}
sum(df1["TOTAL"])
```



```{r}
#generate weekly expection number for St Paul's Hospital based on different reason
# (df2 <- df %>% 
#    group_by(SHIFT_DATE, EARNING_CATEGORY) %>%
#    summarise(total =n()) %>%
#    spread(EARNING_CATEGORY,total))
# df2[is.na(df2)] <- 0
# df2
```

```{r}
# (df3 <- merge(df, df2, by = "SHIFT_DATE", sort = TRUE))
# df3[is.na(df3)] <- 0
```


```{r}
write.csv(df, file = "classification.csv")
```

```{r}
unique(df["EARNING_CATEGORY"])
```







